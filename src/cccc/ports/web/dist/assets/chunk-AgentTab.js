import{r as u,g as oe,R as Y,a as H,j as e,c as m,b as ae,T as ce,P as Z,S as le,d as de,E as ue,I as ge,e as fe}from"./index.js";import{r as me,o as xe}from"./chunk-xterm.js";import"./chunk-react-vendor.js";var be=me();const pe=1e3,he=3e4,ye=10;function Se({actor:a,groupId:G,isVisible:$,onQuit:D,onLaunch:Q,onRelaunch:V,onEdit:ee,onRemove:te,onInbox:ne,busy:re,isDark:d,onStatusChange:M}){const g=a.running??a.enabled??!1,w=a.runner==="headless",_=u.useRef(null),x=u.useRef(null),C=u.useRef(null),b=u.useRef(null),[B,S]=u.useState("disconnected"),X=u.useRef({osc4Idx:new Set,osc10Sent:!1,osc11Sent:!1}),E=u.useRef({inFlight:!1,lastAt:0}),z=u.useRef(0),N=u.useRef(null),P=u.useRef(!1),q=u.useRef(g);u.useEffect(()=>{q.current=g,g&&(P.current=!1)},[g]);const se=async n=>{var c;const l=(n||"").toString();if(!l)return!1;try{if((c=navigator.clipboard)!=null&&c.writeText)return await navigator.clipboard.writeText(l),!0}catch{}try{return window.prompt("Copy to clipboard:",l),!0}catch{return!1}},J=oe(a.runtime,d),K=a.runtime&&Y[a.runtime]?Y[a.runtime]:Y.codex,R=a.unread_count??0,W=n=>{const l=(n||"").trim().toLowerCase(),c=/^#([0-9a-f]{6})$/.exec(l);if(!c)return"0000/0000/0000";const p=c[1]||"000000",T=parseInt(p.slice(0,2),16),j=parseInt(p.slice(2,4),16),o=parseInt(p.slice(4,6),16),y=i=>(i*257).toString(16).padStart(4,"0");return`${y(T)}/${y(j)}/${y(o)}`},ie=()=>{const n=b.current;!n||n.readyState!==WebSocket.OPEN||n.send(JSON.stringify({t:"i",d:""}))};u.useEffect(()=>{x.current&&(x.current.options.theme=H(d))},[d]),u.useEffect(()=>{var j,o,y;if(!_.current||w||!g)return;const n=new be.Terminal({cursorBlink:!0,cursorInactiveStyle:"none",fontSize:13,fontFamily:'"JetBrains Mono", "Fira Code", "SF Mono", Menlo, Monaco, monospace',theme:H(d),scrollback:8e3,allowProposedApi:!0}),l=new xe;n.loadAddon(l),n.open(_.current);const c=()=>n.focus();(j=n.element)==null||j.addEventListener("mousedown",c),(o=n.element)==null||o.addEventListener("touchstart",c);const p=async()=>{try{const i=n.getSelection?n.getSelection():"";return i?await se(i):!1}catch{return!1}};n.attachCustomKeyEventHandler(i=>{var I,F;const f=(i.key||"").toLowerCase(),s=(i.ctrlKey||i.metaKey)&&!i.shiftKey&&f==="c",r=(i.ctrlKey||i.metaKey)&&i.shiftKey&&f==="c",t=(i.ctrlKey||i.metaKey)&&!i.altKey&&f==="v";if((s||r)&&(I=n.hasSelection)!=null&&I.call(n))return p(),!1;if(t){const A=(F=navigator.clipboard)==null?void 0:F.readText;if(typeof A=="function"){i.preventDefault(),i.stopPropagation();const h=Date.now();return E.current.inFlight||h-E.current.lastAt<250||(E.current.inFlight=!0,E.current.lastAt=h,A.call(navigator.clipboard).then(U=>{const O=(U||"").toString();if(O)try{n.paste(O)}catch{}}).catch(()=>{}).finally(()=>{E.current.inFlight=!1})),!1}}return!0});const T=i=>{var f;(f=n.hasSelection)!=null&&f.call(n)&&(i.preventDefault(),p())};return(y=n.element)==null||y.addEventListener("contextmenu",T),x.current=n,C.current=l,setTimeout(()=>l.fit(),0),()=>{var i,f,s;(i=n.element)==null||i.removeEventListener("contextmenu",T),(f=n.element)==null||f.removeEventListener("mousedown",c),(s=n.element)==null||s.removeEventListener("touchstart",c),n.dispose(),x.current=null,C.current=null}},[w,g]),u.useEffect(()=>{if(!$||!g||w||!x.current)return;N.current&&(clearTimeout(N.current),N.current=null);let n=!1,l=null,c=null;const p=()=>{if(n)return;l&&(l.dispose(),l=null),c&&(c.dispose(),c=null),b.current&&(b.current.close(),b.current=null),S("connecting");const j=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/v1/groups/${encodeURIComponent(G)}/actors/${encodeURIComponent(a.id)}/term`,o=new WebSocket(j);o.binaryType="arraybuffer",b.current=o,o.onopen=()=>{if(n){o.close(1e3,"Component unmounted during connection");return}S("connected"),z.current=0,X.current={osc4Idx:new Set,osc10Sent:!1,osc11Sent:!1};const s=x.current;s&&o.send(JSON.stringify({t:"r",c:s.cols,r:s.rows}))};const y=s=>{if(a.runtime!=="opencode"||o.readyState!==WebSocket.OPEN||!x.current)return;const r=H(d),t=x.current.options.theme||r,I=typeof t.background=="string"?t.background:r.background,F=typeof t.foreground=="string"?t.foreground:r.foreground,A=[typeof t.black=="string"?t.black:r.black,typeof t.red=="string"?t.red:r.red,typeof t.green=="string"?t.green:r.green,typeof t.yellow=="string"?t.yellow:r.yellow,typeof t.blue=="string"?t.blue:r.blue,typeof t.magenta=="string"?t.magenta:r.magenta,typeof t.cyan=="string"?t.cyan:r.cyan,typeof t.white=="string"?t.white:r.white,typeof t.brightBlack=="string"?t.brightBlack:r.brightBlack,typeof t.brightRed=="string"?t.brightRed:r.brightRed,typeof t.brightGreen=="string"?t.brightGreen:r.brightGreen,typeof t.brightYellow=="string"?t.brightYellow:r.brightYellow,typeof t.brightBlue=="string"?t.brightBlue:r.brightBlue,typeof t.brightMagenta=="string"?t.brightMagenta:r.brightMagenta,typeof t.brightCyan=="string"?t.brightCyan:r.brightCyan,typeof t.brightWhite=="string"?t.brightWhite:r.brightWhite],h=X.current;!h.osc10Sent&&/\x1b\]10;\?(?:\x07|\x1b\\)/.test(s)&&(h.osc10Sent=!0,o.send(JSON.stringify({t:"i",d:`\x1B]10;rgb:${W(F)}\x07`}))),!h.osc11Sent&&/\x1b\]11;\?(?:\x07|\x1b\\)/.test(s)&&(h.osc11Sent=!0,o.send(JSON.stringify({t:"i",d:`\x1B]11;rgb:${W(I)}\x07`})));const U=/\x1b\]4;(\d+);[?](?:\x07|\x1b\\)/g;let O=null;for(;(O=U.exec(s))!==null;){const k=String(O[1]||"0");if(h.osc4Idx.has(k))continue;h.osc4Idx.add(k);const L=Number.parseInt(k,10);Number.isFinite(L)&&L>=0&&L<A.length?o.send(JSON.stringify({t:"i",d:`\x1B]4;${k};rgb:${W(A[L])}\x07`})):o.send(JSON.stringify({t:"i",d:`\x1B]4;${k};rgb:0000/0000/0000\x07`}))}},i=s=>{if(n)return;y(s);const r=x.current;if(r)try{r.write(s)}catch(t){console.error("terminal write failed",t)}};o.onmessage=s=>{if(!n){if(s.data instanceof ArrayBuffer)i(new TextDecoder().decode(s.data));else if(s.data instanceof Blob)s.data.arrayBuffer().then(r=>i(new TextDecoder().decode(r)));else if(typeof s.data=="string")try{const r=JSON.parse(s.data);r.ok===!1&&r.error&&(i(`\r
[error] ${r.error.message||"Unknown error"}\r
`),r.error.code==="actor_not_running"&&(P.current=!0,M==null||M()))}catch{i(s.data)}}},o.onclose=s=>{if(!n)if(b.current=null,s.code!==1e3&&q.current&&!w&&!P.current){const r=z.current;if(r>=ye){S("disconnected");return}const t=Math.min(pe*Math.pow(2,r),he);S("reconnecting"),N.current=setTimeout(()=>{z.current++,p()},t)}else S("disconnected")},o.onerror=s=>{};const f=x.current;f&&(l=f.onData(s=>{if(o.readyState===WebSocket.OPEN){if((a.runtime==="droid"||a.runtime==="gemini"||a.runtime==="kilocode"||a.runtime==="copilot"||a.runtime==="neovate")&&(/^\x1b\[(?:\?|>)(?:\d+)(?:;\d+)*c$/.test(s)||/^\x1b\](?:10|11);rgb:[0-9a-fA-F]{1,4}\/[0-9a-fA-F]{1,4}\/[0-9a-fA-F]{1,4}(?:\x07|\x1b\\)$/.test(s)||/^\x1b\[[IO]$/.test(s)))return;o.send(JSON.stringify({t:"i",d:s}))}}),c=f.onResize(({cols:s,rows:r})=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({t:"r",c:s,r}))}))};return p(),()=>{n=!0,N.current&&(clearTimeout(N.current),N.current=null),l&&l.dispose(),c&&c.dispose(),b.current&&(b.current.readyState===WebSocket.OPEN&&b.current.close(1e3,"Component cleanup"),b.current=null),S("disconnected")}},[$,g,w,G,a.id,a.runtime]),u.useEffect(()=>{if(!$||!C.current)return;let n=null;const l=()=>{C.current&&C.current.fit()},c=()=>{n&&clearTimeout(n),n=setTimeout(l,100)};return setTimeout(l,50),window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c),n&&clearTimeout(n)}},[$]);const v=re.includes(a.id);return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:m("flex items-center justify-between px-4 py-3 border-b",J.border,J.bg),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:m("w-3 h-3 rounded-full",g?"bg-emerald-500":d?"bg-slate-600":"bg-gray-400")}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:m("font-semibold",J.text),children:a.id}),a.role==="foreman"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-900/50 text-amber-300 font-medium",children:"foreman"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:[(K==null?void 0:K.label)||"Custom"," • ",g?"Running":"Stopped",w&&" • Headless"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[B==="connected"&&e.jsx("span",{className:"text-emerald-400",children:"● Connected"}),B==="connecting"&&e.jsx("span",{className:"text-yellow-400",children:"○ Connecting..."}),B==="reconnecting"&&e.jsx("span",{className:"text-yellow-400",children:"↻ Reconnecting..."})]})]}),e.jsx("div",{className:m("flex-1 min-h-0",d?"bg-slate-950":"bg-gray-50"),style:{contain:"layout",overflow:"hidden"},children:w?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400 dark:text-slate-400 p-8",children:[e.jsx("div",{className:"mb-4",children:e.jsx(ae,{size:48})}),e.jsx("div",{className:"text-lg font-medium mb-2",children:"Headless Agent"}),e.jsx("div",{className:"text-sm text-center max-w-md",children:"This agent runs without a terminal. It communicates via MCP tools and the inbox system."}),g&&e.jsx("div",{className:"mt-4 px-3 py-1.5 rounded bg-emerald-900/30 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 text-sm",children:"Status: Running"})]}):g?e.jsx("div",{ref:_,className:"h-full w-full",style:{contain:"layout paint",overflow:"hidden"}}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-500 dark:text-slate-400 p-8",children:[e.jsx("div",{className:"mb-4",children:e.jsx(ce,{size:48})}),e.jsx("div",{className:"text-lg font-medium mb-2",children:"Agent Not Running"}),e.jsx("div",{className:"text-sm text-center max-w-md mb-4",children:"Click Launch to start this agent's terminal session."}),e.jsxs("button",{onClick:Q,disabled:v,className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium disabled:opacity-50 min-h-[44px] transition-colors","aria-label":"Launch agent",children:[e.jsx(Z,{size:16}),v?"Launching...":"Launch Agent"]})]})}),e.jsxs("div",{className:m("flex items-center gap-2 px-4 py-3 border-t",d?"bg-slate-900/50 border-slate-800":"bg-gray-100 border-gray-200"),children:[g?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:D,disabled:v,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",d?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Quit agent",children:[e.jsx(le,{size:16})," Quit"]}),e.jsx("button",{onClick:ie,disabled:B!=="connected",className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",d?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),title:"Send Ctrl+C to interrupt","aria-label":"Send interrupt signal",children:"⌃C"}),e.jsxs("button",{onClick:V,disabled:v,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",d?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Relaunch agent",children:[e.jsx(de,{size:16})," Relaunch"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Q,disabled:v,className:"flex items-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 text-white text-sm disabled:opacity-50 min-h-[44px] transition-colors","aria-label":"Launch agent",children:[e.jsx(Z,{size:16})," Launch"]}),e.jsxs("button",{onClick:ee,disabled:v,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",d?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Edit agent configuration",children:[e.jsx(ue,{size:16})," Edit"]})]}),e.jsxs("button",{onClick:ne,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm min-h-[44px] transition-colors",R>0?d?"bg-indigo-500/10 text-indigo-200 border border-indigo-500/20 hover:bg-indigo-500/15":"bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100":d?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":`Open inbox${R>0?`, ${R} unread messages`:""}`,children:[e.jsx(ge,{size:16})," Inbox",R>0&&e.jsx("span",{className:m("text-white text-[10px] px-1.5 py-0.5 rounded-full font-semibold tracking-tight shadow-sm",d?"bg-indigo-500":"bg-indigo-600"),"aria-hidden":"true",children:R>99?"99+":R})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("button",{onClick:te,disabled:v||g,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",d?"hover:bg-rose-900/30 text-rose-400":"hover:bg-rose-50 text-rose-600"),title:g?"Stop the agent before removing":"Remove agent","aria-label":"Remove agent",children:[e.jsx(fe,{size:16})," Remove"]})]})]})}export{Se as AgentTab};
