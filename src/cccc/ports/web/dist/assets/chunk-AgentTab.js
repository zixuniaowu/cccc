import{r as d,g as le,R as G,a as Q,j as e,c as m,b as de,T as ue,P as V,S as ge,d as fe,E as me,I as xe,e as be}from"./index.js";import{r as pe,o as he}from"./chunk-xterm.js";import"./chunk-react-vendor.js";var ye=pe();const we=150,Ne=1e3,Re=3e4,ve=10;function Te({actor:a,groupId:X,isVisible:M,onQuit:ee,onLaunch:q,onRelaunch:te,onEdit:ne,onRemove:re,onInbox:se,busy:ie,isDark:u,onStatusChange:F}){const g=a.running??a.enabled??!1,w=a.runner==="headless",z=d.useRef(null),x=d.useRef(null),T=d.useRef(null),b=d.useRef(null),[_,v]=d.useState("disconnected"),[oe,P]=d.useState(!1),S=d.useRef(null),Z=d.useRef({osc4Idx:new Set,osc10Sent:!1,osc11Sent:!1}),C=d.useRef({inFlight:!1,lastAt:0}),J=d.useRef(0),N=d.useRef(null),K=d.useRef(!1),D=d.useRef(g);d.useEffect(()=>{D.current=g,g&&(K.current=!1)},[g]);const ae=async t=>{var c;const l=(t||"").toString();if(!l)return!1;try{if((c=navigator.clipboard)!=null&&c.writeText)return await navigator.clipboard.writeText(l),!0}catch{}try{return window.prompt("Copy to clipboard:",l),!0}catch{return!1}},W=le(a.runtime,u),Y=a.runtime&&G[a.runtime]?G[a.runtime]:G.codex,j=a.unread_count??0,H=t=>{const l=(t||"").trim().toLowerCase(),c=/^#([0-9a-f]{6})$/.exec(l);if(!c)return"0000/0000/0000";const p=c[1]||"000000",A=parseInt(p.slice(0,2),16),E=parseInt(p.slice(2,4),16),o=parseInt(p.slice(4,6),16),y=i=>(i*257).toString(16).padStart(4,"0");return`${y(A)}/${y(E)}/${y(o)}`},ce=()=>{const t=b.current;!t||t.readyState!==WebSocket.OPEN||t.send(JSON.stringify({t:"i",d:""}))};d.useEffect(()=>{x.current&&(x.current.options.theme=Q(u))},[u]),d.useEffect(()=>{var E,o,y;if(!z.current||w||!g)return;const t=new ye.Terminal({cursorBlink:!0,cursorInactiveStyle:"none",fontSize:13,fontFamily:'"JetBrains Mono", "Fira Code", "SF Mono", Menlo, Monaco, monospace',theme:Q(u),scrollback:8e3,allowProposedApi:!0}),l=new he;t.loadAddon(l),t.open(z.current);const c=()=>t.focus();(E=t.element)==null||E.addEventListener("mousedown",c),(o=t.element)==null||o.addEventListener("touchstart",c,{passive:!0});const p=async()=>{try{const i=t.getSelection?t.getSelection():"";return i?await ae(i):!1}catch{return!1}};t.attachCustomKeyEventHandler(i=>{var I,$;const f=(i.key||"").toLowerCase(),s=(i.ctrlKey||i.metaKey)&&!i.shiftKey&&f==="c",r=(i.ctrlKey||i.metaKey)&&i.shiftKey&&f==="c",n=(i.ctrlKey||i.metaKey)&&!i.altKey&&f==="v";if((s||r)&&(I=t.hasSelection)!=null&&I.call(t))return p(),!1;if(n){const O=($=navigator.clipboard)==null?void 0:$.readText;if(typeof O=="function"){i.preventDefault(),i.stopPropagation();const h=Date.now();return C.current.inFlight||h-C.current.lastAt<250||(C.current.inFlight=!0,C.current.lastAt=h,O.call(navigator.clipboard).then(U=>{const k=(U||"").toString();if(k)try{t.paste(k)}catch{}}).catch(()=>{}).finally(()=>{C.current.inFlight=!1})),!1}}return!0});const A=i=>{var f;(f=t.hasSelection)!=null&&f.call(t)&&(i.preventDefault(),p())};return(y=t.element)==null||y.addEventListener("contextmenu",A),x.current=t,T.current=l,setTimeout(()=>l.fit(),0),()=>{var i,f,s;(i=t.element)==null||i.removeEventListener("contextmenu",A),(f=t.element)==null||f.removeEventListener("mousedown",c),(s=t.element)==null||s.removeEventListener("touchstart",c),t.dispose(),x.current=null,T.current=null}},[w,g]),d.useEffect(()=>{if(!M||!g||w||!x.current)return;N.current&&(clearTimeout(N.current),N.current=null);let t=!1,l=null,c=null;const p=()=>{if(t)return;l&&(l.dispose(),l=null),c&&(c.dispose(),c=null),b.current&&(b.current.close(),b.current=null),v("connecting");const E=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/v1/groups/${encodeURIComponent(X)}/actors/${encodeURIComponent(a.id)}/term`,o=new WebSocket(E);o.binaryType="arraybuffer",b.current=o,o.onopen=()=>{if(t){o.close(1e3,"Component unmounted during connection");return}v("connected"),J.current=0,Z.current={osc4Idx:new Set,osc10Sent:!1,osc11Sent:!1},S.current&&clearTimeout(S.current),P(!1),S.current=setTimeout(()=>{t||P(!0)},we);const s=x.current;s&&o.send(JSON.stringify({t:"r",c:s.cols,r:s.rows}))};const y=s=>{if(a.runtime!=="opencode"||o.readyState!==WebSocket.OPEN||!x.current)return;const r=Q(u),n=x.current.options.theme||r,I=typeof n.background=="string"?n.background:r.background,$=typeof n.foreground=="string"?n.foreground:r.foreground,O=[typeof n.black=="string"?n.black:r.black,typeof n.red=="string"?n.red:r.red,typeof n.green=="string"?n.green:r.green,typeof n.yellow=="string"?n.yellow:r.yellow,typeof n.blue=="string"?n.blue:r.blue,typeof n.magenta=="string"?n.magenta:r.magenta,typeof n.cyan=="string"?n.cyan:r.cyan,typeof n.white=="string"?n.white:r.white,typeof n.brightBlack=="string"?n.brightBlack:r.brightBlack,typeof n.brightRed=="string"?n.brightRed:r.brightRed,typeof n.brightGreen=="string"?n.brightGreen:r.brightGreen,typeof n.brightYellow=="string"?n.brightYellow:r.brightYellow,typeof n.brightBlue=="string"?n.brightBlue:r.brightBlue,typeof n.brightMagenta=="string"?n.brightMagenta:r.brightMagenta,typeof n.brightCyan=="string"?n.brightCyan:r.brightCyan,typeof n.brightWhite=="string"?n.brightWhite:r.brightWhite],h=Z.current;!h.osc10Sent&&/\x1b\]10;\?(?:\x07|\x1b\\)/.test(s)&&(h.osc10Sent=!0,o.send(JSON.stringify({t:"i",d:`\x1B]10;rgb:${H($)}\x07`}))),!h.osc11Sent&&/\x1b\]11;\?(?:\x07|\x1b\\)/.test(s)&&(h.osc11Sent=!0,o.send(JSON.stringify({t:"i",d:`\x1B]11;rgb:${H(I)}\x07`})));const U=/\x1b\]4;(\d+);[?](?:\x07|\x1b\\)/g;let k=null;for(;(k=U.exec(s))!==null;){const L=String(k[1]||"0");if(h.osc4Idx.has(L))continue;h.osc4Idx.add(L);const B=Number.parseInt(L,10);Number.isFinite(B)&&B>=0&&B<O.length?o.send(JSON.stringify({t:"i",d:`\x1B]4;${L};rgb:${H(O[B])}\x07`})):o.send(JSON.stringify({t:"i",d:`\x1B]4;${L};rgb:0000/0000/0000\x07`}))}},i=s=>{if(t)return;y(s);const r=x.current;if(r)try{r.write(s)}catch(n){console.error("terminal write failed",n)}};o.onmessage=s=>{if(!t){if(s.data instanceof ArrayBuffer)i(new TextDecoder().decode(s.data));else if(s.data instanceof Blob)s.data.arrayBuffer().then(r=>i(new TextDecoder().decode(r)));else if(typeof s.data=="string")try{const r=JSON.parse(s.data);r.ok===!1&&r.error&&(i(`\r
[error] ${r.error.message||"Unknown error"}\r
`),r.error.code==="actor_not_running"&&(K.current=!0,F==null||F()))}catch{i(s.data)}}},o.onclose=s=>{if(!t)if(b.current=null,s.code!==1e3&&D.current&&!w&&!K.current){const r=J.current;if(r>=ve){v("disconnected");return}const n=Math.min(Ne*Math.pow(2,r),Re);v("reconnecting"),N.current=setTimeout(()=>{J.current++,p()},n)}else v("disconnected")},o.onerror=s=>{};const f=x.current;f&&(l=f.onData(s=>{if(o.readyState===WebSocket.OPEN){if((a.runtime==="droid"||a.runtime==="gemini"||a.runtime==="kilocode"||a.runtime==="copilot"||a.runtime==="neovate")&&(/^\x1b\[(?:\?|>)(?:\d+)(?:;\d+)*c$/.test(s)||/^\x1b\](?:10|11);rgb:[0-9a-fA-F]{1,4}\/[0-9a-fA-F]{1,4}\/[0-9a-fA-F]{1,4}(?:\x07|\x1b\\)$/.test(s)||/^\x1b\[[IO]$/.test(s)))return;o.send(JSON.stringify({t:"i",d:s}))}}),c=f.onResize(({cols:s,rows:r})=>{o.readyState===WebSocket.OPEN&&o.send(JSON.stringify({t:"r",c:s,r}))}))};return p(),()=>{t=!0,N.current&&(clearTimeout(N.current),N.current=null),S.current&&(clearTimeout(S.current),S.current=null),l&&l.dispose(),c&&c.dispose(),b.current&&(b.current.readyState===WebSocket.OPEN&&b.current.close(1e3,"Component cleanup"),b.current=null),v("disconnected"),P(!1)}},[M,g,w,X,a.id,a.runtime]),d.useEffect(()=>{if(!M||!T.current)return;let t=null;const l=()=>{T.current&&T.current.fit()},c=()=>{t&&clearTimeout(t),t=setTimeout(l,100)};return setTimeout(l,50),window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c),t&&clearTimeout(t)}},[M]);const R=ie.includes(a.id);return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:m("flex items-center justify-between px-4 py-3 border-b",W.border,W.bg),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:m("w-3 h-3 rounded-full",g?"bg-emerald-500":u?"bg-slate-600":"bg-gray-400")}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:m("font-semibold",W.text),children:a.id}),a.role==="foreman"&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-900/50 text-amber-300 font-medium",children:"foreman"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:[(Y==null?void 0:Y.label)||"Custom"," • ",g?"Running":"Stopped",w&&" • Headless"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-400",children:[_==="connected"&&e.jsx("span",{className:"text-emerald-400",children:"● Connected"}),_==="connecting"&&e.jsx("span",{className:"text-yellow-400",children:"○ Connecting..."}),_==="reconnecting"&&e.jsx("span",{className:"text-yellow-400",children:"↻ Reconnecting..."})]})]}),e.jsx("div",{className:m("flex-1 min-h-0",u?"bg-slate-950":"bg-gray-50"),style:{contain:"layout",overflow:"hidden"},children:w?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400 dark:text-slate-400 p-8",children:[e.jsx("div",{className:"mb-4",children:e.jsx(de,{size:48})}),e.jsx("div",{className:"text-lg font-medium mb-2",children:"Headless Agent"}),e.jsx("div",{className:"text-sm text-center max-w-md",children:"This agent runs without a terminal. It communicates via MCP tools and the inbox system."}),g&&e.jsx("div",{className:"mt-4 px-3 py-1.5 rounded bg-emerald-900/30 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-300 text-sm",children:"Status: Running"})]}):g?e.jsx("div",{ref:z,className:"h-full w-full transition-opacity duration-100",style:{contain:"layout paint",overflow:"hidden",opacity:oe?1:0}}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-500 dark:text-slate-400 p-8",children:[e.jsx("div",{className:"mb-4",children:e.jsx(ue,{size:48})}),e.jsx("div",{className:"text-lg font-medium mb-2",children:"Agent Not Running"}),e.jsx("div",{className:"text-sm text-center max-w-md mb-4",children:"Click Launch to start this agent's terminal session."}),e.jsxs("button",{onClick:q,disabled:R,className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium disabled:opacity-50 min-h-[44px] transition-colors","aria-label":"Launch agent",children:[e.jsx(V,{size:16}),R?"Launching...":"Launch Agent"]})]})}),e.jsxs("div",{className:m("flex items-center gap-2 px-4 py-3 border-t",u?"bg-slate-900/50 border-slate-800":"bg-gray-100 border-gray-200"),children:[g?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:ee,disabled:R,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",u?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Quit agent",children:[e.jsx(ge,{size:16})," Quit"]}),e.jsx("button",{onClick:ce,disabled:_!=="connected",className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",u?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),title:"Send Ctrl+C to interrupt","aria-label":"Send interrupt signal",children:"⌃C"}),e.jsxs("button",{onClick:te,disabled:R,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",u?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Relaunch agent",children:[e.jsx(fe,{size:16})," Relaunch"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:q,disabled:R,className:"flex items-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 text-white text-sm disabled:opacity-50 min-h-[44px] transition-colors","aria-label":"Launch agent",children:[e.jsx(V,{size:16})," Launch"]}),e.jsxs("button",{onClick:ne,disabled:R,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",u?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":"Edit agent configuration",children:[e.jsx(me,{size:16})," Edit"]})]}),e.jsxs("button",{onClick:se,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm min-h-[44px] transition-colors",j>0?u?"bg-indigo-500/10 text-indigo-200 border border-indigo-500/20 hover:bg-indigo-500/15":"bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100":u?"bg-slate-800 hover:bg-slate-700 text-slate-200":"bg-white hover:bg-gray-50 text-gray-700 border border-gray-300"),"aria-label":`Open inbox${j>0?`, ${j} unread messages`:""}`,children:[e.jsx(xe,{size:16})," Inbox",j>0&&e.jsx("span",{className:m("text-white text-[10px] px-1.5 py-0.5 rounded-full font-semibold tracking-tight shadow-sm",u?"bg-indigo-500":"bg-indigo-600"),"aria-hidden":"true",children:j>99?"99+":j})]}),e.jsx("div",{className:"flex-1"}),e.jsxs("button",{onClick:re,disabled:R||g,className:m("flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm disabled:opacity-50 min-h-[44px] transition-colors",u?"hover:bg-rose-900/30 text-rose-400":"hover:bg-rose-50 text-rose-600"),title:g?"Stop the agent before removing":"Remove agent","aria-label":"Remove agent",children:[e.jsx(be,{size:16})," Remove"]})]})]})}export{Te as AgentTab};
