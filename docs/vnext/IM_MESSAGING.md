# CCCC vNext â€” IM é£æ ¼æ¶ˆæ¯æœºåˆ¶è®¾è®¡

> æ ¸å¿ƒç†å¿µï¼šcccc å°±æ˜¯ä¸€ä¸ª IM ç¾¤èŠï¼Œç¾¤æˆå‘˜æ˜¯ agentsã€‚å¤ç”¨ IM çš„å¿ƒæ™ºæ¨¡å‹ï¼Œè€Œä¸æ˜¯å‘æ˜æ–°æ¦‚å¿µã€‚

## 0. è®¾è®¡åŸåˆ™

### 0.1 IM ç¾¤èŠçš„æ ¸å¿ƒå¥‘çº¦

1. **æ¶ˆæ¯æ˜¯ä¸€ç­‰å…¬æ°‘**ï¼šå‘å‡ºå»å°±è½åœ°ï¼Œæ‰€æœ‰äººå¯è§
2. **å·²è¯»æ˜¯æ˜¾å¼çš„**ï¼šæˆ‘çŸ¥é“ä½ çœ‹åˆ°äº†
3. **å›å¤/å¼•ç”¨æ˜¯ç»“æ„åŒ–çš„**ï¼šä¸Šä¸‹æ–‡ä¸ä¸¢å¤±
4. **@mention æ˜¯ç²¾å‡†æŠ•é€’**ï¼šä¸æ˜¯å¹¿æ’­å™ªéŸ³
5. **æ¶ˆæ¯æµæ˜¯æ—¶é—´çº¿**ï¼šæ–°æ¶ˆæ¯åœ¨åº•éƒ¨ï¼Œå†å²å¯å›æº¯

### 0.2 Agent ä¸äººç±»çš„å…³é”®å·®å¼‚

- **äººç±»æ˜¯ä¸»åŠ¨çš„**ï¼šä¼šä¸»åŠ¨æ‰“å¼€ IM çœ‹æ¶ˆæ¯
- **Agent æ˜¯è¢«åŠ¨çš„**ï¼šéœ€è¦è¢«æé†’å»æ‹‰å– inbox

å› æ­¤ï¼š
- å·²è¯»å¿…é¡»æ˜¯ agent **æ˜¾å¼è°ƒç”¨ MCP** æ ‡è®°çš„
- NUDGE æœºåˆ¶æ˜¯å¿…è¦çš„ï¼ˆæé†’ agent æŸ¥çœ‹ inboxï¼‰
- æŠ•é€’æ˜¯ best-effortï¼Œinbox æ˜¯å…œåº•

## 1. æ¶ˆæ¯æ¨¡å‹ï¼ˆchat.messageï¼‰

### 1.1 ChatMessageData æ‰©å±•

```python
class ChatMessageData(BaseModel):
    # æ ¸å¿ƒå†…å®¹
    text: str
    format: Literal["plain", "markdown"] = "plain"
    
    # IM æ ¸å¿ƒè¯­ä¹‰
    to: list[str] = []                    # @mention æ”¶ä»¶äººï¼ˆç©º=å¹¿æ’­ï¼‰
    reply_to: Optional[str] = None        # å›å¤å“ªæ¡æ¶ˆæ¯ï¼ˆevent_idï¼‰
    quote_text: Optional[str] = None      # è¢«å¼•ç”¨æ¶ˆæ¯çš„æ–‡æœ¬ç‰‡æ®µï¼ˆä¾¿äºå±•ç¤ºï¼‰
    
    # é™„ä»¶ä¸å¼•ç”¨
    refs: list[Reference] = []            # å¼•ç”¨ï¼ˆæ–‡ä»¶/commit/URLï¼‰
    attachments: list[Attachment] = []    # é™„ä»¶å…ƒä¿¡æ¯
    
    # é¢„ç•™
    thread: str = ""                      # è¯é¢˜/çº¿ç¨‹ IDï¼ˆåç½®ï¼‰
    
    # å…ƒæ•°æ®
    client_id: Optional[str] = None       # å®¢æˆ·ç«¯å»é‡ IDï¼ˆå¹‚ç­‰ï¼‰
```

### 1.2 æ”¶ä»¶äººè¯­ä¹‰ï¼ˆto å­—æ®µï¼‰

| Token | è¯­ä¹‰ |
|-------|------|
| `[]`ï¼ˆç©ºï¼‰ | å¹¿æ’­ï¼šæ‰€æœ‰äººå¯è§ï¼Œä½†ä¸å¼ºåˆ¶æŠ•é€’ |
| `user` / `@user` | ç”¨æˆ·æœ¬äºº |
| `@all` | æ‰€æœ‰ actorsï¼ˆå¼ºåˆ¶æŠ•é€’ï¼‰ |
| `@peers` | æ‰€æœ‰ role=peer çš„ actors |
| `@foreman` | role=foreman çš„ actor |
| `<actor_id>` | æŒ‡å®š actorï¼ˆå¦‚ `peer-a`ï¼‰ |
| `<actor_title>` | æŒ‰ title åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼Œä¸å”¯ä¸€åˆ™æŠ¥é”™ï¼‰ |

å†™å…¥ ledger å‰ä¼šè§„èŒƒåŒ–ï¼š
- `@user` â†’ `user`
- title â†’ actor_id
- å»é‡

### 1.3 å›å¤æ¶ˆæ¯ï¼ˆreply_toï¼‰

```json
{
  "kind": "chat.message",
  "by": "peer-a",
  "data": {
    "text": "å·²å®Œæˆï¼ŒPR é“¾æ¥ï¼šhttps://...",
    "reply_to": "evt_abc123",
    "quote_text": "è¯·å¸®æˆ‘å®ç°ç™»å½•åŠŸèƒ½",
    "to": ["user"]
  }
}
```

- `reply_to`ï¼šè¢«å›å¤æ¶ˆæ¯çš„ event_id
- `quote_text`ï¼šè¢«å›å¤æ¶ˆæ¯çš„æ–‡æœ¬ç‰‡æ®µï¼ˆå¯é€‰ï¼Œä¾¿äº UI å±•ç¤ºï¼Œé¿å…å†æŸ¥ä¸€æ¬¡ï¼‰

## 2. å·²è¯»æœºåˆ¶ï¼ˆchat.readï¼‰

### 2.1 å·²è¯»äº‹ä»¶

```python
class ChatReadData(BaseModel):
    actor_id: str      # è°æ ‡è®°çš„
    event_id: str      # å·²è¯»åˆ°å“ªæ¡æ¶ˆæ¯ï¼ˆå«ä¹‹å‰æ‰€æœ‰ï¼‰
```

### 2.2 è¯­ä¹‰çº¦å®š

- **å·²è¯»æ˜¯ actor ä¸»åŠ¨æ ‡è®°çš„**ï¼šè°ƒç”¨ MCP å·¥å…· `cccc.inbox.mark_read`
- **å·²è¯»æ˜¯ç´¯ç§¯çš„**ï¼šæ ‡è®° event_id=X è¡¨ç¤º"X åŠä¹‹å‰çš„æ¶ˆæ¯éƒ½å·²è¯»"
- **å·²è¯»ä¸å¯æ’¤é”€**ï¼šåªèƒ½å¾€å‰æ¨è¿›

### 2.3 æ¸¸æ ‡å­˜å‚¨

```
groups/<group_id>/state/read_cursors.json
{
  "peer-a": { "event_id": "xxx", "ts": "2025-...", "updated_at": "2025-..." },
  "peer-b": { ... }
}
```

## 3. ååº”æœºåˆ¶ï¼ˆchat.reactionï¼‰â€” åç½®

```python
class ChatReactionData(BaseModel):
    event_id: str      # å¯¹å“ªæ¡æ¶ˆæ¯
    actor_id: str      # è°å‘çš„
    emoji: str         # ååº”ç¬¦å·ï¼ˆâœ…/âŒ/ğŸ‘/ğŸ¤”ï¼‰
```

ç”¨é€”ï¼š
- `âœ…` = "æˆ‘æ”¶åˆ°äº†ï¼Œä¼šå¤„ç†"
- `âŒ` = "è¿™ä¸ªæˆ‘åšä¸äº†"
- `ğŸ‘` = "åŒæ„/ç¡®è®¤"
- `ğŸ¤”` = "éœ€è¦æ›´å¤šä¿¡æ¯"

æ¯”å†™ä¸€æ®µæ–‡å­—å›å¤æ›´è½»é‡ã€‚**æ­¤åŠŸèƒ½åç½®å®ç°ã€‚**

## 4. æŠ•é€’æœºåˆ¶

### 4.1 æŠ•é€’æµç¨‹

```
ç”¨æˆ·å‘æ¶ˆæ¯
    â†“
ledger è½ç›˜ï¼ˆchat.message äº‹ä»¶ï¼‰
    â†“
daemon è§£æ to å­—æ®µ
    â†“
å¯¹æ¯ä¸ªç›®æ ‡ actorï¼š
    â”œâ”€ actor åœ¨çº¿ï¼ˆPTY runningï¼‰ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ best-effort æ³¨å…¥ PTY
    â”‚   â””â”€ å¦ â†’ è·³è¿‡ï¼ˆæ¶ˆæ¯ç•™åœ¨ inboxï¼‰
    â†“
ç­‰å¾… agent è°ƒç”¨ cccc.inbox.mark_read
```

### 4.2 æŠ•é€’æ ¼å¼

æ³¨å…¥ PTY çš„æ ¼å¼ï¼š

```
[cccc] user â†’ peer-a: è¯·å¸®æˆ‘å®ç°ç™»å½•åŠŸèƒ½
```

å¦‚æœæ˜¯å›å¤æ¶ˆæ¯ï¼š

```
[cccc] user â†’ peer-a (reply to evt_abc123): å¥½çš„ï¼Œè¯·ç»§ç»­
```

### 4.3 NUDGE æœºåˆ¶

å¦‚æœ actor æœ‰æœªè¯»æ¶ˆæ¯è¶…è¿‡é˜ˆå€¼æ—¶é—´ï¼ˆé»˜è®¤ 60sï¼‰ï¼Œdaemon æ³¨å…¥æé†’ï¼š

```
[cccc:nudge] ä½ æœ‰ 3 æ¡æœªè¯»æ¶ˆæ¯ï¼Œè¯·è°ƒç”¨ cccc.inbox.list æŸ¥çœ‹
```

## 5. MCP å·¥å…·è®¾è®¡

### 5.1 inbox.list â€” è·å–æœªè¯»æ¶ˆæ¯

```python
def inbox_list(
    actor_id: str,
    limit: int = 50,
) -> list[Message]:
    """
    è·å–è¯¥ actor çš„æœªè¯»æ¶ˆæ¯åˆ—è¡¨ã€‚
    
    è¿”å›ï¼šæŒ‰æ—¶é—´å‡åºæ’åˆ—çš„æ¶ˆæ¯åˆ—è¡¨ã€‚
    """
```

### 5.2 inbox.mark_read â€” æ ‡è®°å·²è¯»

```python
def inbox_mark_read(
    actor_id: str,
    event_id: str,
) -> None:
    """
    æ ‡è®°å·²è¯»åˆ°æŒ‡å®šæ¶ˆæ¯ï¼ˆå«ä¹‹å‰æ‰€æœ‰æ¶ˆæ¯ï¼‰ã€‚
    
    å†™å…¥ chat.read äº‹ä»¶åˆ° ledgerã€‚
    """
```

### 5.3 message.send â€” å‘é€æ¶ˆæ¯

```python
def message_send(
    actor_id: str,
    text: str,
    to: list[str] = [],
    reply_to: Optional[str] = None,
    refs: list[dict] = [],
) -> Event:
    """
    å‘é€æ¶ˆæ¯ã€‚
    
    - actor_id: å‘é€è€…
    - text: æ¶ˆæ¯å†…å®¹
    - to: æ”¶ä»¶äººåˆ—è¡¨ï¼ˆç©º=å¹¿æ’­ï¼‰
    - reply_to: å›å¤å“ªæ¡æ¶ˆæ¯ï¼ˆevent_idï¼‰
    - refs: å¼•ç”¨åˆ—è¡¨
    """
```

### 5.4 message.reply â€” å›å¤æ¶ˆæ¯ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰

```python
def message_reply(
    actor_id: str,
    reply_to: str,
    text: str,
    to: list[str] = [],
) -> Event:
    """
    å›å¤æ¶ˆæ¯ã€‚
    
    è‡ªåŠ¨å¡«å…… reply_to å’Œ quote_textã€‚
    """
```

### 5.5 MCP é…ç½®ç¤ºä¾‹

åœ¨ agent runtime çš„ MCP é…ç½®ä¸­æ·»åŠ  cccc-mcpï¼š

```json
{
  "mcpServers": {
    "cccc": {
      "command": "cccc",
      "args": ["mcp"],
      "env": {}
    }
  }
}
```

æˆ–ä½¿ç”¨ Python æ¨¡å—ç›´æ¥è¿è¡Œï¼š

```json
{
  "mcpServers": {
    "cccc": {
      "command": "python3",
      "args": ["-m", "cccc.ports.mcp.main"],
      "env": {}
    }
  }
}
```

## 6. Agent æ ‡å‡†å·¥ä½œæµ

```
1. æ”¶åˆ° SYSTEM æ³¨å…¥
   â†’ çŸ¥é“è‡ªå·±æ˜¯è°ï¼ˆactor_idï¼‰ã€åœ¨å“ªä¸ª group
   â†’ çŸ¥é“å¯ç”¨çš„ MCP å·¥å…·

2. è°ƒç”¨ cccc.inbox.list
   â†’ è·å–æœªè¯»æ¶ˆæ¯åˆ—è¡¨

3. å¤„ç†æ¶ˆæ¯
   â†’ æ‰§è¡Œä»»åŠ¡

4. è°ƒç”¨ cccc.inbox.mark_read
   â†’ æ ‡è®°å·²è¯»ï¼ˆæ¨è¿›æ¸¸æ ‡ï¼‰

5. è°ƒç”¨ cccc.message.reply æˆ– cccc.message.send
   â†’ å›å¤ç»“æœæˆ–å‘é€æ–°æ¶ˆæ¯

6. ç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯
   â†’ æˆ–è¢« NUDGE æé†’
```

## 7. UI å±•ç¤ºè¦æ±‚

### 7.1 æ¶ˆæ¯åˆ—è¡¨

- æ˜¾ç¤ºå‘é€è€…ã€æ—¶é—´ã€å†…å®¹
- å›å¤æ¶ˆæ¯æ˜¾ç¤º"å›å¤äº† xxx"å¹¶å¯ç‚¹å‡»è·³è½¬
- æ”¯æŒ @mention é«˜äº®

### 7.2 å·²è¯»çŠ¶æ€

- å•å‹¾ âœ“ï¼šæ¶ˆæ¯å·²å‘é€
- åŒå‹¾ âœ“âœ“ï¼šæ¶ˆæ¯å·²è¢«ç›®æ ‡ actor æ ‡è®°å·²è¯»

### 7.3 å¿«æ·æ“ä½œ

- ç‚¹å‡»æ¶ˆæ¯å¯å¿«é€Ÿå›å¤
- æ”¯æŒ @mention è‡ªåŠ¨è¡¥å…¨

## 8. å®ç°ä¼˜å…ˆçº§

### Phase 1ï¼šæ¶ˆæ¯è¯­ä¹‰å®Œå–„
1. æ‰©å±• `ChatMessageData` å¢åŠ  `reply_to` / `quote_text` / `client_id`
2. æ›´æ–° `normalize_event_data` å¤„ç†æ–°å­—æ®µ
3. CLI æ”¯æŒ `cccc reply <event_id> "text"`

### Phase 2ï¼šMCP å·¥å…·æš´éœ²
1. åˆ›å»º `cccc-mcp` æœåŠ¡ï¼ˆæˆ–å†…ç½®åˆ° daemonï¼‰
2. å®ç° `inbox.list` / `inbox.mark_read` / `message.send` / `message.reply`
3. æ›´æ–° SYSTEM prompt å‘Šè¯‰ agent å¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·

### Phase 3ï¼šæŠ•é€’æœºåˆ¶å¢å¼º
1. å›å¤æ¶ˆæ¯çš„æŠ•é€’æ ¼å¼
2. NUDGE æœºåˆ¶å®Œå–„

### Phase 4ï¼šUI é€‚é…
1. Web å±•ç¤ºå›å¤å…³ç³»
2. æ˜¾ç¤ºå·²è¯»çŠ¶æ€
3. æ”¯æŒå¿«é€Ÿå›å¤

### Phase 5ï¼šReactionï¼ˆåç½®ï¼‰
1. æ–°å¢ `chat.reaction` äº‹ä»¶
2. MCP æš´éœ² `message.react`
3. UI å±•ç¤º emoji ååº”
